<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0a1628">
    <meta name="description" content="Sistema de Gesti√≥n de Inspecciones DONET">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>DONET - Sistema de Gesti√≥n</title>
    <link rel="stylesheet" href="styles.css?v=7">
</head>

<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="screen active">
        <div class="login-container-new">
            <div class="logo-container-large">
                <img src="logo-donet-new.jpg" alt="DONET Logo" class="logo-main-new">
            </div>
            <h1 class="app-title-new">APLICACIONES - DONET</h1>
            <div class="title-underline"></div>

            <div class="login-box-new">
                <h2 class="login-title">Iniciar Sesi√≥n</h2>
                <form id="loginForm">
                    <div class="input-group-new">
                        <input type="text" id="username" class="input-field-new" placeholder="Usuario" required>
                    </div>
                    <div class="input-group-new">
                        <input type="password" id="password" class="input-field-new" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-entrar">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Men√∫ Principal -->
    <div id="menuScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <img src="logo-donet-final.svg" alt="DONET" class="header-logo">
                <h1>SISTEMA DE GESTI√ìN - DONET</h1>
                <button id="logoutBtn" class="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="menu-container">
            <div class="welcome-section">
                <h2>Bienvenido, <span id="supervisorName"></span></h2>
                <p class="date-display" id="currentDate"></p>
            </div>

            <div class="menu-cards">
                <div class="menu-card" onclick="showScreen('registerScreen')">
                    <div class="card-icon">üìù</div>
                    <h3>Registrar Inspecci√≥n</h3>
                    <p>Ingresar nuevos datos y fotograf√≠as</p>
                </div>

                <div class="menu-card" id="btnCargaMasiva" onclick="requestAdminAccess()" style="display: none;">
                    <div class="card-icon">üì§</div>
                    <h3>Carga Masiva</h3>
                    <p>Importar datos desde Excel</p>
                </div>

                <div class="menu-card" onclick="showScreen('consultScreen')">
                    <div class="card-icon">üîç</div>
                    <h3>Consultar Registros</h3>
                    <p>Ver registros de otros periodos</p>
                </div>

                <div class="menu-card" onclick="showScreen('reportsScreen')">
                    <div class="card-icon">üìä</div>
                    <h3>Reportes</h3>
                    <p>Generar y descargar reportes</p>
                </div>

                <div class="menu-card" id="btnMapaUbicaciones" onclick="window.location.href='mapa-ubicaciones.html'"
                    style="display: none;">
                    <div class="card-icon">üó∫Ô∏è</div>
                    <h3>Mapa de Ubicaciones</h3>
                    <p>Ver ubicaciones GPS y tiempo de permanencia</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Registro -->
    <div id="registerScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <img src="logo-donet-final.svg" alt="DONET" class="header-logo">
                <h1>REGISTRO DE INSPECCI√ìN</h1>
                <button onclick="showScreen('menuScreen')" class="btn-back">‚Üê Volver</button>
            </div>
        </div>

        <div class="form-container">
            <form id="registerForm">
                <div class="form-section">
                    <h3>Informaci√≥n General</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Cuenta Contrato</label>
                            <select id="cuentaContrato" required>
                                <option value="">Seleccione una cuenta contrato</option>
                            </select>
                            <small style="color: #888; display: block; margin-top: 5px;">
                                Solo se muestran las cuentas asignadas a tu usuario
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="fecha" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Observaci√≥n 1</label>
                            <textarea id="observacion1" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Observaci√≥n 2</label>
                            <textarea id="observacion2" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Fotograf√≠as</h3>
                    <div class="photos-grid">
                        <div class="photo-upload">
                            <label for="foto1">
                                <div class="upload-box" id="preview1">
                                    <span class="upload-icon">üì∑</span>
                                    <span class="upload-text">Foto 1</span>
                                </div>
                            </label>
                            <input type="file" id="foto1" accept="image/*" onchange="previewImage(1)">
                        </div>

                        <div class="photo-upload">
                            <label for="foto2">
                                <div class="upload-box" id="preview2">
                                    <span class="upload-icon">üì∑</span>
                                    <span class="upload-text">Foto 2</span>
                                </div>
                            </label>
                            <input type="file" id="foto2" accept="image/*" onchange="previewImage(2)">
                        </div>

                        <div class="photo-upload">
                            <label for="foto3">
                                <div class="upload-box" id="preview3">
                                    <span class="upload-icon">üì∑</span>
                                    <span class="upload-text">Foto 3</span>
                                </div>
                            </label>
                            <input type="file" id="foto3" accept="image/*" onchange="previewImage(3)">
                        </div>

                        <div class="photo-upload">
                            <label for="foto4">
                                <div class="upload-box" id="preview4">
                                    <span class="upload-icon">üì∑</span>
                                    <span class="upload-text">Foto 4</span>
                                </div>
                            </label>
                            <input type="file" id="foto4" accept="image/*" onchange="previewImage(4)">
                        </div>

                        <div class="photo-upload">
                            <label for="foto5">
                                <div class="upload-box" id="preview5">
                                    <span class="upload-icon">üì∑</span>
                                    <span class="upload-text">Foto 5</span>
                                </div>
                            </label>
                            <input type="file" id="foto5" accept="image/*" onchange="previewImage(5)">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="resetForm()" class="btn-secondary">Limpiar</button>
                    <button type="submit" class="btn-primary">Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pantalla de Consulta -->
    <div id="consultScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <img src="logo-donet-final.svg" alt="DONET" class="header-logo">
                <h1>CONSULTAR REGISTROS</h1>
                <button onclick="showScreen('menuScreen')" class="btn-back">‚Üê Volver</button>
            </div>
        </div>

        <div class="consult-container">
            <div class="search-section">
                <h3>Filtros de B√∫squeda</h3>
                <div class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cuenta Contrato</label>
                            <input type="text" id="searchCuenta" placeholder="Ingrese n√∫mero de cuenta">
                        </div>

                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="searchFechaInicio">
                        </div>

                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="searchFechaFin">
                        </div>

                        <div class="form-group">
                            <button onclick="buscarRegistros()" class="btn-primary">Buscar</button>
                            <button onclick="cargarTodosLosRegistros()" class="btn-secondary"
                                style="margin-left: 10px;">Ver Todos</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <h3>Resultados</h3>
                <div id="resultsContainer">
                    <p class="no-results">Utilice los filtros para buscar registros</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Reportes -->
    <div id="reportsScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <img src="logo-donet-final.svg" alt="DONET" class="header-logo">
                <h1>üìä Reportes</h1>
                <button onclick="showScreen('menuScreen')" class="btn-back">‚Üê Volver</button>
            </div>
        </div>

        <div class="reports-container">
            <!-- Secci√≥n de filtros -->
            <div class="reports-filter-section">
                <h3>Seleccionar Periodo</h3>

                <div class="filter-type-toggle">
                    <button class="filter-toggle-btn active" onclick="setFilterType('month')" id="btnMonthFilter">
                        üìÖ Mes Completo
                    </button>
                    <button class="filter-toggle-btn" onclick="setFilterType('range')" id="btnRangeFilter">
                        üìÜ Rango Personalizado
                    </button>
                </div>

                <!-- Filtro por mes -->
                <div id="monthFilter" class="filter-option active">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Mes</label>
                            <select id="reportMonth">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>A√±o</label>
                            <select id="reportYear"></select>
                        </div>
                        <div class="form-group">
                            <button onclick="generateReport()" class="btn-primary">üîç Buscar</button>
                        </div>
                    </div>
                </div>

                <!-- Filtro por rango -->
                <div id="rangeFilter" class="filter-option">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="reportEndDate">
                        </div>
                        <div class="form-group">
                            <button onclick="generateReport()" class="btn-primary">üîç Buscar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de descarga -->
            <div class="reports-download-section">
                <div class="download-group">
                    <h3>üìÑ Reporte Detallado</h3>
                    <p class="download-description">Todos los campos de cada registro</p>
                    <div class="download-buttons">
                        <button onclick="downloadReport('csv', 'detailed')" class="btn-download btn-green">
                            üì• CSV Detallado
                        </button>
                        <button onclick="downloadReport('excel', 'detailed')" class="btn-download btn-excel">
                            üìó Excel Detallado
                        </button>
                        <button onclick="downloadReport('pdf', 'detailed')" class="btn-download btn-red">
                            üìï PDF Detallado
                        </button>
                    </div>
                </div>

                <div class="download-group">
                    <h3>üìä Reporte Resumido</h3>
                    <p class="download-description">Datos consolidados por categor√≠a</p>
                    <div class="download-buttons">
                        <button onclick="downloadReport('csv', 'summary')" class="btn-download btn-green">
                            üì• CSV Resumido
                        </button>
                        <button onclick="downloadReport('excel', 'summary')" class="btn-download btn-excel">
                            üìó Excel Resumido
                        </button>
                        <button onclick="downloadReport('pdf', 'summary')" class="btn-download btn-red">
                            üìï PDF Resumido
                        </button>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de compartir -->
            <div class="reports-share-section">
                <h3>üì± Compartir por WhatsApp</h3>
                <div class="share-buttons">
                    <button onclick="shareWhatsApp('detailed')" class="btn-whatsapp">
                        <span class="whatsapp-icon">üí¨</span>
                        Compartir Detallado
                    </button>
                    <button onclick="shareWhatsApp('summary')" class="btn-whatsapp">
                        <span class="whatsapp-icon">üí¨</span>
                        Compartir Resumido
                    </button>
                </div>
            </div>

            <!-- Tipos de reportes info -->
            <div class="reports-info-section">
                <h3>üìã Tipos de Reportes</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>Detallado:</h4>
                        <p>Planilla completa con todos los campos de cada registro diario.</p>
                    </div>
                    <div class="info-card">
                        <h4>Resumido:</h4>
                        <p>Consolidado con totales por categor√≠a.</p>
                    </div>
                    <div class="info-card">
                        <h4>CSV:</h4>
                        <p>Formato de hoja de c√°lculo compatible con Excel, Google Sheets, etc.</p>
                    </div>
                    <div class="info-card">
                        <h4>PDF:</h4>
                        <p>Documento formateado listo para imprimir o compartir.</p>
                    </div>
                </div>
            </div>

            <!-- Registros del mes -->
            <div class="reports-preview-section">
                <h3>Registros del Mes <span id="previewCount" class="count-badge">0 registros</span></h3>
                <div id="reportPreviewTable"></div>
            </div>
        </div>
    </div>

    <!-- Modal Login Admin para Carga Masiva -->
    <div id="adminLoginModal" class="login-modal" style="display: none;">
        <div class="login-box-admin">
            <div class="logo-container" style="text-align: center; margin-bottom: 20px;">
                <img src="logo-donet-final.svg" alt="DONET Logo" style="max-width: 80px; border-radius: 50%;">
            </div>
            <h2 style="color: #00d9ff; text-align: center; margin-bottom: 20px;">Acceso Administrativo</h2>
            <p style="color: #ccc; text-align: center; margin-bottom: 20px;">Ingrese credenciales de administrador</p>
            <form id="adminAccessForm">
                <div class="input-group">
                    <input type="text" id="adminAccessUser" placeholder="Usuario Administrador" required>
                </div>
                <div class="input-group">
                    <input type="password" id="adminAccessPass" placeholder="Contrase√±a" required>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" onclick="closeAdminModal()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Acceder</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </div>
    </div>
    </div>

    <div class="results-section">
        <h3>Resultados</h3>
        <div id="resultsContainer">
            <p class="no-results">Utilice los filtros para buscar registros</p>
        </div>
    </div>
    </div>
    </div>

    <!-- Pantalla de Reportes -->
    <div id="reportsScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <img src="logo-donet-final.svg" alt="DONET" class="header-logo">
                <h1>üìä Reportes</h1>
                <button onclick="showScreen('menuScreen')" class="btn-back">‚Üê Volver</button>
            </div>
        </div>

        <div class="reports-container">
            <!-- Secci√≥n de filtros -->
            <div class="reports-filter-section">
                <h3>Seleccionar Periodo</h3>

                <div class="filter-type-toggle">
                    <button class="filter-toggle-btn active" onclick="setFilterType('month')" id="btnMonthFilter">
                        üìÖ Mes Completo
                    </button>
                    <button class="filter-toggle-btn" onclick="setFilterType('range')" id="btnRangeFilter">
                        üìÜ Rango Personalizado
                    </button>
                </div>

                <!-- Filtro por mes -->
                <div id="monthFilter" class="filter-option active">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Mes</label>
                            <select id="reportMonth">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>A√±o</label>
                            <select id="reportYear"></select>
                        </div>
                        <div class="form-group">
                            <button onclick="generateReport()" class="btn-primary">üîç Buscar</button>
                        </div>
                    </div>
                </div>

                <!-- Filtro por rango -->
                <div id="rangeFilter" class="filter-option">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="reportEndDate">
                        </div>
                        <div class="form-group">
                            <button onclick="generateReport()" class="btn-primary">üîç Buscar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de descarga -->
            <div class="reports-download-section">
                <div class="download-group">
                    <h3>üìÑ Reporte Detallado</h3>
                    <p class="download-description">Todos los campos de cada registro</p>
                    <div class="download-buttons">
                        <button onclick="downloadReport('csv', 'detailed')" class="btn-download btn-green">
                            üì• CSV Detallado
                        </button>
                        <button onclick="downloadReport('excel', 'detailed')" class="btn-download btn-excel">
                            üìó Excel Detallado
                        </button>
                        <button onclick="downloadReport('pdf', 'detailed')" class="btn-download btn-red">
                            üìï PDF Detallado
                        </button>
                    </div>
                </div>

                <div class="download-group">
                    <h3>üìä Reporte Resumido</h3>
                    <p class="download-description">Datos consolidados por categor√≠a</p>
                    <div class="download-buttons">
                        <button onclick="downloadReport('csv', 'summary')" class="btn-download btn-green">
                            üì• CSV Resumido
                        </button>
                        <button onclick="downloadReport('excel', 'summary')" class="btn-download btn-excel">
                            üìó Excel Resumido
                        </button>
                        <button onclick="downloadReport('pdf', 'summary')" class="btn-download btn-red">
                            üìï PDF Resumido
                        </button>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de compartir -->
            <div class="reports-share-section">
                <h3>üì± Compartir por WhatsApp</h3>
                <div class="share-buttons">
                    <button onclick="shareWhatsApp('detailed')" class="btn-whatsapp">
                        <span class="whatsapp-icon">üí¨</span>
                        Compartir Detallado
                    </button>
                    <button onclick="shareWhatsApp('summary')" class="btn-whatsapp">
                        <span class="whatsapp-icon">üí¨</span>
                        Compartir Resumido
                    </button>
                </div>
            </div>

            <!-- Tipos de reportes info -->
            <div class="reports-info-section">
                <h3>üìã Tipos de Reportes</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>Detallado:</h4>
                        <p>Planilla completa con todos los campos de cada registro diario.</p>
                    </div>
                    <div class="info-card">
                        <h4>Resumido:</h4>
                        <p>Consolidado con totales por categor√≠a.</p>
                    </div>
                    <div class="info-card">
                        <h4>CSV:</h4>
                        <p>Formato de hoja de c√°lculo compatible con Excel, Google Sheets, etc.</p>
                    </div>
                    <div class="info-card">
                        <h4>PDF:</h4>
                        <p>Documento formateado listo para imprimir o compartir.</p>
                    </div>
                </div>
            </div>

            <!-- Registros del mes -->
            <div class="reports-preview-section">
                <h3>Registros del Mes <span id="previewCount" class="count-badge">0 registros</span></h3>
                <div id="reportPreviewTable"></div>
            </div>
        </div>
    </div>

    <!-- Modal Login Admin para Carga Masiva -->
    <div id="adminLoginModal" class="login-modal" style="display: none;">
        <div class="login-box-admin">
            <div class="logo-container" style="text-align: center; margin-bottom: 20px;">
                <img src="logo-donet-final.svg" alt="DONET Logo" style="max-width: 80px; border-radius: 50%;">
            </div>
            <h2 style="color: #00d9ff; text-align: center; margin-bottom: 20px;">Acceso Administrativo</h2>
            <p style="color: #ccc; text-align: center; margin-bottom: 20px;">Ingrese credenciales de administrador</p>
            <form id="adminAccessForm">
                <div class="input-group">
                    <input type="text" id="adminAccessUser" placeholder="Usuario Administrador" required>
                </div>
                <div class="input-group">
                    <input type="password" id="adminAccessPass" placeholder="Contrase√±a" required>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" onclick="closeAdminModal()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Acceder</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js?v=7"></script>
    <script src="device-fingerprint.js?v=7"></script>
    <script src="geolocation-tracker.js?v=7"></script>
    <script>
        // Estado de la aplicaci√≥n
        let currentUser = null;

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            setupEventListeners();
            setCurrentDate();

            // Verificar si hay sesi√≥n activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showScreen('menuScreen');
                updateUserInfo();
            }
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Register form
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }

            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Set fecha actual por defecto
            const fechaInput = document.getElementById('fecha');
            if (fechaInput) {
                fechaInput.value = new Date().toISOString().split('T')[0];
            }
        }

        // Manejar login
        async function handleLogin(e) {
            e.preventDefault();
            showLoading(true);

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                if (!supabase) {
                    showMessage('Error: Supabase no est√° configurado', 'error');
                    showLoading(false);
                    return;
                }

                // FIX: Declarar variables expl√≠citamente con var para m√°xima compatibilidad
                var userData = null;
                var isSpecialUser = false;

                // Primero intentar buscar en la tabla 'usuarios' (para prueba, admin, y otros)
                try {
                    const { data: usuarioData, error: usuarioError } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('username', username)
                        .eq('activo', true)
                        .single();

                    if (usuarioData && !usuarioError) {
                        // Usuario encontrado en tabla usuarios
                        // Validar contrase√±a (comparaci√≥n simple, en producci√≥n usar bcrypt en backend)
                        if (usuarioData.password === password) {
                            userData = usuarioData;
                            isSpecialUser = true;

                            // Adaptar estructura para compatibilidad
                            userData.usuario = userData.username;
                        } else {
                            showMessage('Usuario o contrase√±a incorrectos', 'error');
                            showLoading(false);
                            return;
                        }
                    }
                } catch (err) {
                    console.log('Usuario no encontrado en tabla usuarios, buscando en supervisores...');
                }

                // Si no se encontr√≥ en usuarios, buscar en supervisores
                if (!userData) {
                    const { data: supervisorData, error: supervisorError } = await supabase
                        .from('supervisores')
                        .select('*')
                        .eq('usuario', username)
                        .eq('password', password)
                        .eq('activo', true)
                        .single();

                    if (supervisorError || !supervisorData) {
                        showMessage('Usuario o contrase√±a incorrectos', 'error');
                        showLoading(false);
                        return;
                    }

                    userData = supervisorData;
                }

                // Verificar l√≠mite de dispositivos para usuario "prueba"
                if (username === 'prueba' && typeof DeviceFingerprint !== 'undefined') {
                    try {
                        const deviceFP = new DeviceFingerprint();
                        const fingerprint = await deviceFP.generate();

                        // Verificar acceso del dispositivo
                        const { data: accessCheck, error: accessError } = await supabase
                            .rpc('check_device_access', {
                                p_user_id: userData.id,
                                p_device_fingerprint: fingerprint
                            });

                        if (accessError) {
                            console.error('Error verificando acceso:', accessError);
                        } else if (accessCheck && !accessCheck.allowed) {
                            showMessage(accessCheck.message || 'Acceso denegado. L√≠mite de dispositivos alcanzado.', 'error');
                            showLoading(false);
                            return;
                        } else if (accessCheck && accessCheck.allowed) {
                            const deviceCount = accessCheck.device_count || 0;
                            if (deviceCount >= 4) {
                                setTimeout(() => {
                                    alert(`‚ö†Ô∏è ADVERTENCIA: Tienes ${deviceCount} de 5 dispositivos registrados. Quedan ${5 - deviceCount} disponibles.`);
                                }, 1000);
                            }
                        }
                    } catch (fpError) {
                        console.error('Error con device fingerprint:', fpError);
                    }
                }

                currentUser = userData;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showScreen('menuScreen');
                updateUserInfo();

                // Solicitar permisos de geolocalizaci√≥n autom√°ticamente
                // SOLICITAR GPS OBLIGATORIO Y REGISTRAR
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            console.log('GPS obtenido:', position.coords);
                            // Registrar ubicaci√≥n en la base de datos
                            try {
                                await supabase.from('ubicaciones_gps').insert({
                                    usuario_id: currentUser.id,
                                    device_fingerprint: await window.DeviceFingerprint?.getFingerprint() || 'unknown',
                                    device_type: /mobile/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                                    latitud: position.coords.latitude,
                                    longitud: position.coords.longitude,
                                    precision_metros: position.coords.accuracy,
                                    timestamp_entrada: new Date().toISOString(),
                                    actividad_realizada: 'Inicio de Sesion',
                                    ip_address: 'unknown',
                                    user_agent: navigator.userAgent
                                });
                                console.log('Ubicacion registrada correctamente');
                            } catch (error) {
                                console.error('Error registrando ubicacion:', error);
                            }
                        },
                        function(error) {
                            console.warn('Error GPS:', error);
                            alert('Es necesario activar el GPS para usar esta aplicacion. Por favor, permita el acceso a su ubicacion.');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    alert('Su navegador no soporta geolocalizacion.');
                }

                // Limpiar formulario
                document.getElementById('loginForm').reset();

            } catch (error) {
                console.error('Error en login:', error);
                showMessage('Error al iniciar sesi√≥n', 'error');
            }

            showLoading(false);
        }

        // Manejar logout
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showScreen('loginScreen');
            document.getElementById('loginForm').reset();
        }

        // Actualizar informaci√≥n del usuario
        function updateUserInfo() {
            const supervisorName = document.getElementById('supervisorName');
            if (supervisorName && currentUser) {
                supervisorName.textContent = currentUser.nombre;
            }

            // Mostrar/ocultar botones administrativos seg√∫n rol
            const btnCargaMasiva = document.getElementById('btnCargaMasiva');
            const btnMapaUbicaciones = document.getElementById('btnMapaUbicaciones');

            if (btnCargaMasiva && btnMapaUbicaciones && currentUser) {
                // Solo mostrar a usuarios admin o prueba
                const tieneAccesoAdmin = currentUser.rol === 'admin' || currentUser.rol === 'prueba';

                btnCargaMasiva.style.display = tieneAccesoAdmin ? 'block' : 'none';
                btnMapaUbicaciones.style.display = tieneAccesoAdmin ? 'block' : 'none';

                console.log(`Acceso administrativo: ${tieneAccesoAdmin ? 'CONCEDIDO' : 'DENEGADO'} (Rol: ${currentUser.rol})`);
            }
        }

        // Establecer fecha actual
        function setCurrentDate() {
            const dateDisplay = document.getElementById('currentDate');
            if (dateDisplay) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateDisplay.textContent = new Date().toLocaleDateString('es-ES', options);
            }
        }

        // Manejar registro de inspecci√≥n
        async function handleRegister(e) {
            e.preventDefault();
            showLoading(true);

            try {
                // Obtener datos del formulario
                const formData = {
                    supervisor_id: currentUser.id,
                    cuenta_contrato: document.getElementById('cuentaContrato').value,
                    fecha: document.getElementById('fecha').value,
                    observacion1: document.getElementById('observacion1').value,
                    observacion2: document.getElementById('observacion2').value
                };

                // Procesar las fotos
                const fotos = [];
                for (let i = 1; i <= 5; i++) {
                    const fileInput = document.getElementById(`foto${i}`);
                    if (fileInput.files.length > 0) {
                        const base64 = await fileToBase64(fileInput.files[0]);
                        fotos.push(base64);
                    } else {
                        fotos.push(null);
                    }
                }

                formData.foto1 = fotos[0];
                formData.foto2 = fotos[1];
                formData.foto3 = fotos[2];
                formData.foto4 = fotos[3];
                formData.foto5 = fotos[4];

                if (!supabase) {
                    // Modo de desarrollo
                    console.log('Datos a guardar:', formData);
                    showMessage('Registro guardado correctamente (modo desarrollo)', 'success');
                    resetForm();
                    showLoading(false);
                    return;
                }

                // Actualizar en Supabase (UPDATE, no INSERT)
                // Los registros ya existen desde la carga masiva, solo agregamos fotos y observaciones
                const { data, error } = await supabase
                    .from('inspecciones')
                    .update({
                        foto1: formData.foto1,
                        foto2: formData.foto2,
                        foto3: formData.foto3,
                        foto4: formData.foto4,
                        foto5: formData.foto5,
                        observaciones: formData.observacion1,
                        observaciones_2: formData.observacion2
                    })
                    .eq('cuenta_contrato', formData.cuenta_contrato)
                    .eq('supervisor_id', currentUser.id)
                    .select();

                if (error) {
                    throw error;
                }

                if (!data || data.length === 0) {
                    throw new Error('No se encontr√≥ la cuenta contrato para actualizar');
                }

                showMessage('Fotos y observaciones guardadas correctamente', 'success');
                resetForm();

            } catch (error) {
                console.error('Error al guardar registro:', error);
                showMessage('Error al guardar el registro', 'error');
            }

            showLoading(false);
        }

        // Buscar registros
        async function buscarRegistros() {
            showLoading(true);

            const cuenta = document.getElementById('searchCuenta').value;
            const fechaInicio = document.getElementById('searchFechaInicio').value;
            const fechaFin = document.getElementById('searchFechaFin').value;

            try {
                if (!supabase) {
                    // Modo de desarrollo - datos de ejemplo
                    const ejemploRegistros = [
                        {
                            id: 1,
                            cuenta_contrato: '12345',
                            fecha: '2025-01-15',
                            observacion1: 'Inspecci√≥n inicial realizada',
                            observacion2: 'Todo en orden',
                            foto1: null,
                            foto2: null,
                            foto3: null,
                            foto4: null,
                            foto5: null
                        }
                    ];
                    displayResults(ejemploRegistros);
                    showLoading(false);
                    return;
                }

                // Construir query - FILTRAR POR SUPERVISOR (excepto usuario "prueba")
                let query = supabase
                    .from('inspecciones')
                    .select('*')
                    .order('fecha_carga', { ascending: false });

                // **NUEVO: Solo filtrar por supervisor si NO es usuario "prueba"**
                // Usuarios con acceso total: prueba, admin, luiggy
                const usuariosAdmin = ['prueba', 'admin', 'luiggy'];
                if (!usuariosAdmin.includes(currentUser.usuario)) {
                    query = query.eq('supervisor_id', currentUser.id);
                }

                if (cuenta) {
                    query = query.ilike('cuenta_contrato', `%${cuenta}%`);
                }

                if (fechaInicio) {
                    query = query.gte('fecha_carga', fechaInicio);
                }

                if (fechaFin) {
                    query = query.lte('fecha_carga', fechaFin);
                }

                const { data, error } = await query;

                if (error) {
                    throw error;
                }

                displayResults(data);

            } catch (error) {
                console.error('Error al buscar registros:', error);
                showMessage('Error al buscar registros', 'error');
            }

            showLoading(false);
        }

        // Mostrar resultados de b√∫squeda
        function displayResults(registros) {
            const container = document.getElementById('resultsContainer');

            if (!registros || registros.length === 0) {
                container.innerHTML = '<p class="no-results">No se encontraron registros</p>';
                return;
            }

            container.innerHTML = '';

            registros.forEach(registro => {
                const card = document.createElement('div');
                card.className = 'result-card';

                card.innerHTML = `
                    <div class="result-header">
                        <h4>Cuenta: ${registro.cuenta_contrato}</h4>
                        <span class="date-badge">${formatDate(registro.fecha_carga)}</span>
                    </div>

                    <div class="result-info">
                        <div class="info-item">
                            <span class="info-label">Distrito:</span>
                            <span class="info-value">${registro.distrito || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Direcci√≥n:</span>
                            <span class="info-value">${registro.direccion_instalacion || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Inspector:</span>
                            <span class="info-value">${registro.nombre_dni_inspector || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Observaciones:</span>
                            <span class="info-value">${registro.observaciones || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Observaciones 2:</span>
                            <span class="info-value">${registro.observaciones_2 || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="result-photos">
                        ${generatePhotoHTML(registro.foto1, 1)}
                        ${generatePhotoHTML(registro.foto2, 2)}
                        ${generatePhotoHTML(registro.foto3, 3)}
                        ${generatePhotoHTML(registro.foto4, 4)}
                        ${generatePhotoHTML(registro.foto5, 5)}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Generar HTML para foto
        function generatePhotoHTML(foto, index) {
            if (foto) {
                return `
                    <div class="result-photo" onclick="viewPhoto('${foto}')">
                        <img src="${foto}" alt="Foto ${index}">
                    </div>
                `;
            } else {
                return `
                    <div class="result-photo empty-photo">
                        <span>-</span>
                    </div>
                `;
            }
        }

        // Ver foto en grande
        function viewPhoto(fotoUrl) {
            window.open(fotoUrl, '_blank');
        }

        // Formatear fecha
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        // Preview de imagen
        function previewImage(index) {
            const fileInput = document.getElementById(`foto${index}`);
            const preview = document.getElementById(`preview${index}`);

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview ${index}">`;
                    preview.classList.add('has-image');
                };

                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        // Convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Resetear formulario
        function resetForm() {
            document.getElementById('registerForm').reset();

            // Limpiar previews de fotos
            for (let i = 1; i <= 5; i++) {
                const preview = document.getElementById(`preview${i}`);
                preview.innerHTML = `
                    <span class="upload-icon">üì∑</span>
                    <span class="upload-text">Foto ${i}</span>
                `;
                preview.classList.remove('has-image');
            }

            // Restablecer fecha actual
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        }

        // Cargar cuentas contrato del supervisor
        async function loadCuentasContrato() {
            if (!currentUser || !supabase) {
                console.log('No hay usuario o supabase no est√° configurado');
                return;
            }

            try {
                // **NUEVO: Usuario "prueba" ve TODAS las cuentas**
                let query = supabase
                    .from('inspecciones')
                    .select('cuenta_contrato, supervisor_id, supervisores(nombre)')
                    .order('cuenta_contrato');

                // Solo filtrar por supervisor_id si NO es usuario "prueba"
                // Usuarios con acceso total: prueba, admin, luiggy
                const usuariosAdmin = ['prueba', 'admin', 'luiggy'];
                if (!usuariosAdmin.includes(currentUser.usuario)) {
                    query = query.eq('supervisor_id', currentUser.id);
                }

                const { data, error } = await query;

                if (error) throw error;

                // Obtener cuentas √∫nicas
                const cuentasUnicas = [...new Set(data.map(item => item.cuenta_contrato))];

                // Llenar el select
                const selectElement = document.getElementById('cuentaContrato');
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">Seleccione una cuenta contrato</option>';
                    cuentasUnicas.forEach(cuenta => {
                        const option = document.createElement('option');
                        option.value = cuenta;
                        option.textContent = cuenta;
                        selectElement.appendChild(option);
                    });

                    const userType = currentUser.usuario === 'prueba' ? 'TODAS las' : 'las';
                    console.log(`Cargadas ${cuentasUnicas.length} ${userType} cuentas contrato`);
                }
            } catch (error) {
                console.error('Error al cargar cuentas contrato:', error);
            }
        }

        // Cambiar de pantalla
        function showScreen(screenId) {
            // Ocultar todas las pantallas
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Mostrar la pantalla solicitada
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');

                // Si es la pantalla de registro, cargar las cuentas contrato
                if (screenId === 'registerScreen') {
                    loadCuentasContrato();
                }

                // Si es la pantalla de consulta, cargar todos los registros autom√°ticamente
                if (screenId === 'consultScreen') {
                    cargarTodosLosRegistros();
                }
            }
        }

        // Cargar todos los registros del supervisor autom√°ticamente
        async function cargarTodosLosRegistros() {
            showLoading(true);

            try {
                if (!supabase || !currentUser) {
                    showMessage('Error: No hay sesi√≥n activa', 'error');
                    showLoading(false);
                    return;
                }

                // **NUEVO: Usuario "prueba" ve TODOS los registros**
                let query = supabase
                    .from('inspecciones')
                    .select('*')
                    .order('fecha_carga', { ascending: false })
                    .limit(100); // Limitar a 100 para no sobrecargar

                // Solo filtrar por supervisor_id si NO es usuario "prueba"
                // Usuarios con acceso total: prueba, admin, luiggy
                const usuariosAdmin = ['prueba', 'admin', 'luiggy'];
                if (!usuariosAdmin.includes(currentUser.usuario)) {
                    query = query.eq('supervisor_id', currentUser.id);
                }

                const { data, error } = await query;

                if (error) {
                    throw error;
                }

                const userType = currentUser.usuario === 'prueba' ? 'TODOS los supervisores' : `el supervisor ${currentUser.nombre}`;
                console.log(`Se encontraron ${data.length} registros de ${userType}`);
                displayResults(data);

            } catch (error) {
                console.error('Error al cargar registros:', error);
                showMessage(`Error al cargar registros: ${error.message}`, 'error');
                displayResults([]);
            }

            showLoading(false);
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        // Mostrar mensajes
        function showMessage(message, type = 'info') {
            // Crear elemento de mensaje
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;

            // Estilos del mensaje
            Object.assign(messageDiv.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 25px',
                borderRadius: '8px',
                color: '#fff',
                fontWeight: '600',
                zIndex: '10000',
                animation: 'slideInRight 0.3s ease',
                boxShadow: '0 4px 20px rgba(0, 0, 0, 0.3)'
            });

            // Color seg√∫n tipo
            if (type === 'success') {
                messageDiv.style.background = '#00d4ff';
                messageDiv.style.color = '#0a1628';
            } else if (type === 'error') {
                messageDiv.style.background = '#ff4444';
            } else {
                messageDiv.style.background = '#2a3f5f';
            }

            document.body.appendChild(messageDiv);

            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        // Agregar animaciones CSS para mensajes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }

            .date-badge {
                background: var(--cyan);
                color: var(--primary-bg);
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
            }
        `;
        document.head.appendChild(style);

        // ==========================================
        // FUNCIONES PARA ACCESO ADMINISTRATIVO
        // ==========================================

        function requestAdminAccess() {
            const modal = document.getElementById('adminLoginModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminLoginModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.getElementById('adminAccessForm').reset();
            }
        }

        // Manejar envo del formulario de acceso administrativo
        document.addEventListener('DOMContentLoaded', () => {
            const adminForm = document.getElementById('adminAccessForm');
            if (adminForm) {
                adminForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const user = document.getElementById('adminAccessUser').value;
                    const pass = document.getElementById('adminAccessPass').value;

                    if (!user || !pass) {
                        showMessage('Por favor ingrese usuario y contrasea', 'error');
                        return;
                    }

                    showLoading(true);

                    try {
                        // Verificar credenciales de administrador
                        // Primero intentamos validacin directa si es el admin por defecto
                        if (user === 'admin' && pass === 'admin2025') {
                            showMessage('Acceso concedido', 'success');
                            setTimeout(() => {
                                window.location.href = 'carga-masiva.html';
                            }, 1000);
                            return;
                        }

                        // Si no es el default, verificamos en base de datos
                        const { data, error } = await supabase
                            .from('usuarios')
                            .select('*')
                            .eq('username', user)
                            .eq('rol', 'admin')
                            .eq('activo', true)
                            .single();

                        if (error || !data) {
                            throw new Error('Credenciales invlidas');
                        }

                        // Validacin simplificada para otros admins (si los hubiera)
                        // En produccin usar bcrypt
                        showMessage('Solo el administrador principal puede acceder a esta funcin por ahora', 'error');

                    } catch (error) {
                        console.error('Error de acceso:', error);
                        showMessage('Credenciales de administrador incorrectas', 'error');
                    } finally {
                        showLoading(false);
                    }
                });
            }
        });

        // ==========================================
        // FUNCIONES DE GEOLOCALIZACI√ìN AUTOM√ÅTICA
        // ==========================================

        /**
         * Solicitar permisos de geolocalizaci√≥n al usuario
         * Se ejecuta autom√°ticamente despu√©s del login exitoso
         */
        async function requestGeolocationPermission() {
            // Verificar soporte de geolocalizaci√≥n
            if (!('geolocation' in navigator)) {
                console.warn('‚ö†Ô∏è Geolocalizaci√≥n no soportada en este navegador');
                showMessage('‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n', 'warning');
                return;
            }

            try {
                console.log('üìç Solicitando permisos de geolocalizaci√≥n...');

                // Solicitar permiso y obtener ubicaci√≥n
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        }
                    );
                });

                const locationData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                console.log('‚úÖ Ubicaci√≥n GPS obtenida:', locationData);

                // Guardar en localStorage
                localStorage.setItem('lastKnownLocation', JSON.stringify(locationData));

                // NUEVO: Registrar inmediatamente en la base de datos
                await registerLocationImmediately(locationData);

                // Mostrar notificaci√≥n al usuario
                showMessage(`üìç Ubicaci√≥n GPS activada (Precisi√≥n: ${Math.round(locationData.accuracy)}m)`, 'success');

                // Iniciar rastreo continuo si GeolocationTracker est√° disponible
                if (typeof GeolocationTracker !== 'undefined' && currentUser) {
                    initializeLocationTracking();
                } else {
                    console.warn('‚ö†Ô∏è GeolocationTracker no disponible, solo se registr√≥ ubicaci√≥n inicial');
                }

            } catch (error) {
                console.error('‚ùå Error al obtener ubicaci√≥n GPS:', error);

                if (error.code === error.PERMISSION_DENIED) {
                    showMessage('‚ö†Ô∏è Es necesario activar el GPS para usar la aplicaci√≥n', 'error');
                } else if (error.code === error.TIMEOUT) {
                    showMessage('‚ö†Ô∏è Tiempo de espera agotado al obtener GPS', 'warning');
                } else {
                    showMessage('‚ö†Ô∏è Error al obtener ubicaci√≥n GPS', 'error');
                }
            }
        }

        /**
         * Registrar ubicaci√≥n inmediatamente en Supabase
         */
        async function registerLocationImmediately(location) {
            if (!currentUser || !supabase) return;

            try {
                const { error } = await supabase
                    .from('ubicaciones_gps')
                    .insert({
                        supervisor_id: currentUser.id,
                        latitud: location.latitude,
                        longitud: location.longitude,
                        precision: location.accuracy,
                        timestamp: new Date().toISOString()
                    });

                if (error) throw error;
                console.log('‚úÖ Ubicaci√≥n registrada en BD');
            } catch (error) {
                console.error('‚ùå Error al registrar ubicaci√≥n en BD:', error);
            }
        }
    </script>
    <script src="reports.js?v=7"></script>
    <script src="reports-excel-formatter.js?v=7"></script>
</body>

</html>