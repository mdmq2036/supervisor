<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPA SIMPLE - TODAS LAS UBICACIONES</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1628;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        #header {
            background: linear-gradient(135deg, #1a2744 0%, #0d1829 100%);
            padding: 20px;
            border-bottom: 2px solid #00d9ff;
        }

        h1 {
            color: #00d9ff;
            font-size: 24px;
            margin-bottom: 10px;
        }

        #stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat {
            background: rgba(0, 217, 255, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            border-left: 3px solid #00d9ff;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
        }

        .stat-value {
            font-size: 24px;
            color: #00d9ff;
            font-weight: bold;
        }

        #map {
            height: calc(100vh - 150px);
            width: 100%;
        }

        .popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 10px;
        }

        .popup-info {
            font-size: 13px;
            line-height: 1.6;
        }

        .popup-duration {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 12px;
            border: 2px solid #00d9ff;
            z-index: 10000;
            font-size: 18px;
        }

        .custom-marker {
            background: transparent;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è MAPA DE UBICACIONES - TODAS LAS UBICACIONES</h1>
        <p style="color: #718096;">Versi√≥n simplificada sin filtros - Muestra TODAS las ubicaciones de la base de datos</p>
        <div id="stats">
            <div class="stat">
                <div class="stat-label">Total Ubicaciones</div>
                <div class="stat-value" id="totalUbicaciones">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Usuarios</div>
                <div class="stat-value" id="totalUsuarios">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Dispositivos</div>
                <div class="stat-value" id="totalDispositivos">-</div>
            </div>
        </div>
    </div>

    <div id="loading">‚è≥ Cargando ubicaciones...</div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        const API_URL = window.location.origin;

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-12.0464, -77.0428], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            console.log('‚úÖ Mapa inicializado');
        }

        // Cargar ubicaciones TODAS SIN FILTROS
        async function cargarTodasLasUbicaciones() {
            try {
                console.log('üîç Cargando TODAS las ubicaciones desde la API...');
                console.log('üìç URL:', `${API_URL}/api/ubicaciones`);

                const response = await fetch(`${API_URL}/api/ubicaciones`);

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const ubicaciones = await response.json();

                console.log(`‚úÖ Ubicaciones recibidas: ${ubicaciones.length}`);
                console.log('üì¶ Datos completos:', ubicaciones);

                // Ocultar loading
                document.getElementById('loading').style.display = 'none';

                // Actualizar estad√≠sticas
                actualizarEstadisticas(ubicaciones);

                // Mostrar en mapa
                mostrarEnMapa(ubicaciones);

            } catch (error) {
                console.error('‚ùå Error al cargar ubicaciones:', error);
                document.getElementById('loading').innerHTML = `
                    ‚ùå Error: ${error.message}<br>
                    <small style="color: #ff6b6b;">Verifica la consola para m√°s detalles</small>
                `;
            }
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas(ubicaciones) {
            const total = ubicaciones.length;
            const usuarios = new Set(ubicaciones.map(u => u.usuario_id)).size;
            const dispositivos = new Set(ubicaciones.map(u => u.device_fingerprint)).size;

            document.getElementById('totalUbicaciones').textContent = total;
            document.getElementById('totalUsuarios').textContent = usuarios;
            document.getElementById('totalDispositivos').textContent = dispositivos;

            console.log(`üìä Estad√≠sticas: ${total} ubicaciones, ${usuarios} usuarios, ${dispositivos} dispositivos`);
        }

        // Mostrar ubicaciones en el mapa
        function mostrarEnMapa(ubicaciones) {
            if (ubicaciones.length === 0) {
                alert('‚ö†Ô∏è No hay ubicaciones en la base de datos');
                return;
            }

            const bounds = [];
            const colores = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#fd79a8', '#fdcb6e'];

            ubicaciones.forEach((ubicacion, index) => {
                const lat = parseFloat(ubicacion.latitud);
                const lon = parseFloat(ubicacion.longitud);

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn('‚ö†Ô∏è Coordenadas inv√°lidas:', ubicacion);
                    return;
                }

                bounds.push([lat, lon]);

                // Color del marcador
                const color = colores[index % colores.length];

                // Crear icono
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: ${color};
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 14px;
                    ">${index + 1}</div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });

                // Crear marcador
                const marker = L.marker([lat, lon], { icon: icon }).addTo(map);

                // Popup
                const fechaEntrada = new Date(ubicacion.timestamp_entrada);
                const fechaSalida = ubicacion.timestamp_salida ? new Date(ubicacion.timestamp_salida) : null;

                const duracion = ubicacion.duracion_minutos
                    ? `${Math.round(ubicacion.duracion_minutos)} min`
                    : 'En curso';

                const popupContent = `
                    <div class="popup-title">üìç Ubicaci√≥n #${index + 1}</div>
                    <div class="popup-info">
                        <strong>Usuario:</strong> ${ubicacion.nombre || ubicacion.username || 'N/A'}<br>
                        <strong>Dispositivo:</strong> ${ubicacion.device_type === 'mobile' ? 'üì± M√≥vil' : 'üíª PC'}<br>
                        <strong>Entrada:</strong> ${fechaEntrada.toLocaleString('es-PE')}<br>
                        ${fechaSalida ? `<strong>Salida:</strong> ${fechaSalida.toLocaleString('es-PE')}<br>` : ''}
                        <strong>Actividad:</strong> ${ubicacion.actividad_realizada || 'N/A'}<br>
                        <strong>Precisi√≥n:</strong> ${Math.round(ubicacion.precision_metros)} metros<br>
                        <strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                    </div>
                    <div class="popup-duration">‚è±Ô∏è ${duracion}</div>
                `;

                marker.bindPopup(popupContent);

                console.log(`‚úÖ Marcador ${index + 1} agregado:`, ubicacion.username, lat, lon);
            });

            // Dibujar ruta si hay m√∫ltiples puntos
            if (bounds.length > 1) {
                L.polyline(bounds, {
                    color: '#00d9ff',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 5'
                }).addTo(map);

                console.log('‚úÖ Ruta dibujada con', bounds.length, 'puntos');
            }

            // Ajustar vista
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
                console.log('‚úÖ Mapa ajustado a', bounds.length, 'ubicaciones');
            }
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando mapa simple...');
            console.log('üåê URL de la aplicaci√≥n:', API_URL);

            initMap();
            cargarTodasLasUbicaciones();
        });
    </script>
</body>
</html>
