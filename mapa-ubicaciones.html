<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Ubicaciones - DONET</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Config -->
    <script src="config.js"></script>

    <!-- Geolocation Tracker -->
    <script src="geolocation-tracker.js"></script>

    <!-- Mapa Utils -->
    <script src="mapa-utils.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2942 100%);
            color: #fff;
            min-height: 100vh;
        }

        .map-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .map-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .map-header h1 {
            font-size: 2.5em;
            color: #00d9ff;
            margin-bottom: 10px;
        }

        .map-header p {
            color: #a0aec0;
            font-size: 1.1em;
        }

        .filters-section {
            background: #1a2942;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #2d3748;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #00d9ff;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #2d3748;
            background: #0a1628;
            color: #fff;
            font-size: 1em;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-filter {
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: #0a1628;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: #2d3748;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        #map {
            height: 600px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 3px solid #00d9ff;
            box-shadow: 0 10px 40px rgba(0, 217, 255, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a2942 0%, #0a1628 100%);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #2d3748;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #00d9ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.2);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #00d9ff;
            margin: 10px 0;
        }

        .stat-label {
            color: #a0aec0;
            font-size: 0.9em;
        }

        .locations-list {
            background: #1a2942;
            padding: 25px;
            border-radius: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .locations-list h3 {
            color: #00d9ff;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .location-item {
            background: #0a1628;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #00d9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .location-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 217, 255, 0.2);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .location-time {
            color: #00d9ff;
            font-weight: 600;
        }

        .location-duration {
            background: #2d3748;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #fff;
        }

        .location-details {
            color: #a0aec0;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .location-coords {
            font-family: monospace;
            color: #718096;
            font-size: 0.85em;
        }

        /* Estilos para popups del mapa */
        .leaflet-popup-content-wrapper {
            background: #1a2942;
            color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-title {
            color: #00d9ff;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .popup-info {
            color: #a0aec0;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .popup-duration {
            background: #00d9ff;
            color: #0a1628;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #2d3748;
            border-top: 4px solid #00d9ff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .map-container {
                padding: 10px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            #map {
                height: 400px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="map-container">
        <!-- Header -->
        <div class="map-header">
            <h1>üó∫Ô∏è Mapa de Ubicaciones y Tiempo de Permanencia</h1>
            <p>Visualizaci√≥n de ubicaciones GPS y an√°lisis de tiempo de permanencia</p>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <h3 style="color: #00d9ff; margin-top: 0;">Filtros de B√∫squeda</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Usuario</label>
                    <select id="filterUsuario">
                        <option value="">Todos los usuarios</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Fecha Inicio</label>
                    <input type="date" id="filterFechaInicio">
                </div>
                <div class="filter-group">
                    <label>Fecha Fin</label>
                    <input type="date" id="filterFechaFin">
                </div>
                <div class="filter-group">
                    <label>Tipo de Dispositivo</label>
                    <select id="filterDeviceType">
                        <option value="">Todos</option>
                        <option value="mobile">M√≥vil</option>
                        <option value="desktop">PC</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
                <button class="btn-filter btn-primary" id="btnBuscar" onclick="cargarUbicaciones()">Buscar</button>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìç</div>
                <div class="stat-value" id="statTotalUbicaciones">0</div>
                <div class="stat-label">Total de Ubicaciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="statTiempoPromedio">0 min</div>
                <div class="stat-label">Tiempo Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì±</div>
                <div class="stat-value" id="statDispositivos">0</div>
                <div class="stat-label">Dispositivos √önicos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üåç</div>
                <div class="stat-value" id="statDistanciaTotal">0 km</div>
                <div class="stat-label">Distancia Total</div>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map"></div>

        <!-- Lista de ubicaciones -->
        <div class="locations-list">
            <h3>üìã Historial de Ubicaciones</h3>
            <div id="locationsList"></div>
        </div>

        <!-- Bot√≥n volver -->
        <div style="margin-top: 30px; text-align: center;">
            <button onclick="window.location.href='index.html'" class="btn-filter btn-secondary">
                ‚Üê Volver al Men√∫ Principal
            </button>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        /**
         * MAPA DE UBICACIONES GPS - VERSI√ìN INLINE
         * √öltima actualizaci√≥n: 2025-12-02
         */

        // Configuraci√≥n de API
        const MAP_API_URL = window.location.origin;

        console.log('üó∫Ô∏è Iniciando Mapa de Ubicaciones (Inline)');
        console.log('üì° API URL:', MAP_API_URL);
        function actualizarMapa(ubicaciones) {
            if (!map) {
                console.error('‚ùå Mapa no inicializado');
                return;
            }

            // Limpiar marcadores existentes
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Limpiar polil√≠nea
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }

            if (ubicaciones.length === 0) {
                console.log('‚ö†Ô∏è No hay ubicaciones para mostrar');
                return;
            }

            console.log(`üìç Agregando ${ubicaciones.length} marcadores al mapa`);

            const bounds = [];
            const routePoints = [];

            // Crear marcadores
            ubicaciones.forEach((ubicacion, index) => {
                const lat = parseFloat(ubicacion.latitud);
                const lon = parseFloat(ubicacion.longitud);

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn(`Coordenadas inv√°lidas en ubicaci√≥n ${index}`);
                    return;
                }

                bounds.push([lat, lon]);
                routePoints.push([lat, lon]);

                // Color seg√∫n duraci√≥n
                const color = getMarkerColor(ubicacion.duracion_minutos);

                // Crear icono personalizado
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: ${color};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">${index + 1}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                // Crear marcador
                const marker = L.marker([lat, lon], { icon: icon }).addTo(map);

                // Crear popup
                const popupContent = crearPopupContent(ubicacion, index + 1);
                marker.bindPopup(popupContent);

                markers.push(marker);
            });

            // Dibujar ruta si hay m√∫ltiples puntos
            if (routePoints.length > 1) {
                polyline = L.polyline(routePoints, {
                    color: '#00d9ff',
                    weight: 3,
                    opacity: 0.6,
                    dashArray: '10, 5'
                }).addTo(map);
            }

            // Ajustar vista del mapa
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            console.log(`‚úÖ ${markers.length} marcadores agregados`);
        }

        /**
         * Obtener color del marcador seg√∫n duraci√≥n
         */
        function getMarkerColor(duracionMinutos) {
            if (!duracionMinutos) return '#718096'; // Gris - en curso
            if (duracionMinutos < 5) return '#48bb78'; // Verde - muy corta
            if (duracionMinutos < 15) return '#4299e1'; // Azul - corta
            if (duracionMinutos < 30) return '#ed8936'; // Naranja - media
            if (duracionMinutos < 60) return '#f56565'; // Rojo - larga
            return '#9f7aea'; // P√∫rpura - muy larga
        }

        /**
         * Crear contenido del popup
         */
        function crearPopupContent(ubicacion, numero) {
            const fechaEntrada = new Date(ubicacion.timestamp_entrada);
            const fechaSalida = ubicacion.timestamp_salida ? new Date(ubicacion.timestamp_salida) : null;

            const duracion = ubicacion.duracion_minutos
                ? formatearDuracion(ubicacion.duracion_minutos)
                : 'En curso';

            return `
                <div class="popup-title">üìç Ubicaci√≥n #${numero}</div>
                <div class="popup-info">
                    <strong>Usuario:</strong> ${ubicacion.nombre || ubicacion.username || 'N/A'}<br>
                    <strong>Dispositivo:</strong> ${ubicacion.device_type === 'mobile' ? 'üì± M√≥vil' : 'üíª PC'}<br>
                    <strong>Entrada:</strong> ${formatearFechaPer√∫(fechaEntrada)}<br>
                    ${fechaSalida ? `<strong>Salida:</strong> ${formatearFechaPer√∫(fechaSalida)}<br>` : ''}
                    <strong>Actividad:</strong> ${ubicacion.actividad_realizada || 'N/A'}<br>
                    ${ubicacion.cuenta_contrato ? `<strong>Cuenta:</strong> ${ubicacion.cuenta_contrato}<br>` : ''}
                    <strong>Precisi√≥n:</strong> ${Math.round(ubicacion.precision_metros)} metros<br>
                    <strong>Coordenadas:</strong> ${ubicacion.latitud.toFixed(6)}, ${ubicacion.longitud.toFixed(6)}
                </div>
                <div class="popup-duration">‚è±Ô∏è ${duracion}</div>
            `;
        }

        /**
         * Actualizar estad√≠sticas
         */
        function actualizarEstadisticas(ubicaciones) {
            const totalUbicaciones = ubicaciones.length;

            // Calcular tiempo promedio
            const duraciones = ubicaciones
                .filter(u => u.duracion_minutos)
                .map(u => u.duracion_minutos);

            const tiempoPromedio = duraciones.length > 0
                ? Math.round(duraciones.reduce((a, b) => a + b, 0) / duraciones.length)
                : 0;

            // Contar dispositivos √∫nicos
            const dispositivosUnicos = new Set(ubicaciones.map(u => u.device_fingerprint)).size;

            // Calcular distancia total
            let distanciaTotal = 0;
            for (let i = 1; i < ubicaciones.length; i++) {
                const prev = ubicaciones[i - 1];
                const curr = ubicaciones[i];

                if (prev.latitud && prev.longitud && curr.latitud && curr.longitud) {
                    distanciaTotal += calcularDistancia(
                        prev.latitud, prev.longitud,
                        curr.latitud, curr.longitud
                    );
                }
            }

            // Actualizar UI
            const elTotal = document.getElementById('statTotalUbicaciones');
            const elTiempo = document.getElementById('statTiempoPromedio');
            const elDispositivos = document.getElementById('statDispositivos');
            const elDistancia = document.getElementById('statDistanciaTotal');

            if (elTotal) elTotal.textContent = totalUbicaciones;
            if (elTiempo) elTiempo.textContent = `${tiempoPromedio} min`;
            if (elDispositivos) elDispositivos.textContent = dispositivosUnicos;
            if (elDistancia) elDistancia.textContent = `${(distanciaTotal / 1000).toFixed(2)} km`;
        }

        /**
         * Mostrar lista de ubicaciones
         */
        function mostrarListaUbicaciones(ubicaciones) {
            const container = document.getElementById('locationsList');
            if (!container) return;

            if (ubicaciones.length === 0) {
                container.innerHTML = '<p style="color: #718096;">No hay ubicaciones para mostrar</p>';
                return;
            }

            container.innerHTML = ubicaciones.map((ubicacion, index) => {
                const fechaEntrada = new Date(ubicacion.timestamp_entrada);
                const duracion = ubicacion.duracion_minutos
                    ? formatearDuracion(ubicacion.duracion_minutos)
                    : 'En curso';

                return `
                    <div class="location-item" onclick="centrarMapa(${ubicacion.latitud}, ${ubicacion.longitud}, ${index})" data-id="${ubicacion.id}">
                        <div class="location-header">
                            <span class="location-time">
                                ${ubicacion.device_type === 'mobile' ? 'üì±' : 'üíª'}
                                ${formatearFechaPer√∫(fechaEntrada)}
                            </span>
                            <span class="location-duration">‚è±Ô∏è ${duracion}</span>
                        </div>
                        <div class="location-details">
                            <strong>${ubicacion.nombre || ubicacion.username || 'Usuario desconocido'}</strong><br>
                            ${ubicacion.actividad_realizada ? `Actividad: ${ubicacion.actividad_realizada}<br>` : ''}
                            ${ubicacion.cuenta_contrato ? `Cuenta: ${ubicacion.cuenta_contrato}<br>` : ''}
                            <span class="location-coords">
                                üìç ${ubicacion.latitud.toFixed(6)}, ${ubicacion.longitud.toFixed(6)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Centrar mapa en una ubicaci√≥n
         */
        function centrarMapa(lat, lon, markerIndex) {
            if (!map) return;

            map.setView([lat, lon], 16);

            if (markers[markerIndex]) {
                markers[markerIndex].openPopup();
            }
        }

        /**
         * Calcular distancia entre dos puntos (Haversine)
         */
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        /**
         * Formatear fecha/hora para zona horaria de Per√∫ (UTC-5)
         */
        function formatearFechaPer√∫(fecha) {
            if (!fecha) return 'N/A';

            const fechaObj = fecha instanceof Date ? fecha : new Date(fecha);

            return fechaObj.toLocaleString('es-PE', {
                timeZone: 'America/Lima',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        /**
         * Formatear duraci√≥n
         */
        function formatearDuracion(minutos) {
            if (minutos < 60) {
                return `${Math.round(minutos)} min`;
            } else {
                const horas = Math.floor(minutos / 60);
                const mins = Math.round(minutos % 60);
                return `${horas}h ${mins}min`;
            }
        }

        /**
         * Limpiar filtros
         */
        function limpiarFiltros() {
            const u = document.getElementById('filterUsuario');
            const fi = document.getElementById('filterFechaInicio');
            const ff = document.getElementById('filterFechaFin');
            const dt = document.getElementById('filterDeviceType');

            if (u) u.value = '';
            if (fi) fi.value = '';
            if (ff) ff.value = '';
            if (dt) dt.value = '';

            cargarUbicaciones(true);
        }

        /**
         * Mostrar/ocultar loading
         */
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        /**
         * Mostrar mensaje temporal
         */
        function mostrarMensaje(mensaje, tipo = 'info') {
            let messageEl = document.getElementById('tempMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'tempMessage';
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    max-width: 400px;
                `;
                document.body.appendChild(messageEl);
            }

            const colores = {
                info: '#4299e1',
                error: '#f56565',
                success: '#48bb78',
                warning: '#ed8936'
            };

            messageEl.style.background = colores[tipo] || colores.info;
            messageEl.textContent = mensaje;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        /**
         * Verificar autenticaci√≥n
         */
        function verificarAutenticacion() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('Debe iniciar sesi√≥n para acceder a esta p√°gina');
                window.location.href = 'index.html';
                return false;
            }
            return true;
            const elTiempo = document.getElementById('statTiempoPromedio');
            const elDispositivos = document.getElementById('statDispositivos');
            const elDistancia = document.getElementById('statDistanciaTotal');

            if (elTotal) elTotal.textContent = totalUbicaciones;
            if (elTiempo) elTiempo.textContent = `${tiempoPromedio} min`;
            if (elDispositivos) elDispositivos.textContent = dispositivosUnicos;
            if (elDistancia) elDistancia.textContent = `${(distanciaTotal / 1000).toFixed(2)} km`;
        }

        /**
         * Mostrar lista de ubicaciones
         */
        function mostrarListaUbicaciones(ubicaciones) {
            const container = document.getElementById('locationsList');
            if (!container) return;

            if (ubicaciones.length === 0) {
                container.innerHTML = '<p style="color: #718096;">No hay ubicaciones para mostrar</p>';
                return;
            }

            container.innerHTML = ubicaciones.map((ubicacion, index) => {
                const fechaEntrada = new Date(ubicacion.timestamp_entrada);
                const duracion = ubicacion.duracion_minutos
                    ? formatearDuracion(ubicacion.duracion_minutos)
                    : 'En curso';

                return `
                    <div class="location-item" onclick="centrarMapa(${ubicacion.latitud}, ${ubicacion.longitud}, ${index})" data-id="${ubicacion.id}">
                        <div class="location-header">
                            <span class="location-time">
                                ${ubicacion.device_type === 'mobile' ? 'üì±' : 'üíª'}
                                ${formatearFechaPer√∫(fechaEntrada)}
                            </span>
                            <span class="location-duration">‚è±Ô∏è ${duracion}</span>
                        </div>
                        <div class="location-details">
                            <strong>${ubicacion.nombre || ubicacion.username || 'Usuario desconocido'}</strong><br>
                            ${ubicacion.actividad_realizada ? `Actividad: ${ubicacion.actividad_realizada}<br>` : ''}
                            ${ubicacion.cuenta_contrato ? `Cuenta: ${ubicacion.cuenta_contrato}<br>` : ''}
                            <span class="location-coords">
                                üìç ${ubicacion.latitud.toFixed(6)}, ${ubicacion.longitud.toFixed(6)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Centrar mapa en una ubicaci√≥n
         */
        function centrarMapa(lat, lon, markerIndex) {
            if (!map) return;

            map.setView([lat, lon], 16);

            if (markers[markerIndex]) {
                markers[markerIndex].openPopup();
            }
        }

        /**
         * Calcular distancia entre dos puntos (Haversine)
         */
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        /**
         * Formatear fecha/hora para zona horaria de Per√∫ (UTC-5)
         */
        function formatearFechaPer√∫(fecha) {
            if (!fecha) return 'N/A';

            const fechaObj = fecha instanceof Date ? fecha : new Date(fecha);

            return fechaObj.toLocaleString('es-PE', {
                timeZone: 'America/Lima',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        /**
         * Formatear duraci√≥n
         */
        function formatearDuracion(minutos) {
            if (minutos < 60) {
                return `${Math.round(minutos)} min`;
            } else {
                const horas = Math.floor(minutos / 60);
                const mins = Math.round(minutos % 60);
                return `${horas}h ${mins}min`;
            }
        }

        /**
         * Limpiar filtros
         */
        function limpiarFiltros() {
            const u = document.getElementById('filterUsuario');
            const fi = document.getElementById('filterFechaInicio');
            const ff = document.getElementById('filterFechaFin');
            const dt = document.getElementById('filterDeviceType');

            if (u) u.value = '';
            if (fi) fi.value = '';
            if (ff) ff.value = '';
            if (dt) dt.value = '';

            cargarUbicaciones(true);
        }

        /**
         * Mostrar/ocultar loading
         */
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        /**
         * Mostrar mensaje temporal
         */
        function mostrarMensaje(mensaje, tipo = 'info') {
            let messageEl = document.getElementById('tempMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'tempMessage';
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    max-width: 400px;
                `;
                document.body.appendChild(messageEl);
            }

            const colores = {
                info: '#4299e1',
                error: '#f56565',
                success: '#48bb78',
                warning: '#ed8936'
            };

            messageEl.style.background = colores[tipo] || colores.info;
            messageEl.textContent = mensaje;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        /**
         * Verificar autenticaci√≥n
         */
        function verificarAutenticacion() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('Debe iniciar sesi√≥n para acceder a esta p√°gina');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        /**
         * Inicializaci√≥n del documento
         */
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìÑ DOM cargado - Script Inline');

            // Inicializar Supabase (CR√çTICO: Sin esto no hay conexi√≥n)
            if (typeof initSupabase === 'function') {
                initSupabase();
            } else {
                console.error('‚ùå initSupabase no est√° definido');
                mostrarMensaje('Error cr√≠tico: No se pudo conectar a la base de datos', 'error');
                return;
            }

            // Verificar autenticaci√≥n
            if (!verificarAutenticacion()) {
                return;
            }

            console.log('‚úÖ Usuario autenticado');

            // Verificar que Leaflet est√© disponible
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet no est√° cargado');
                mostrarMensaje('Error: Librer√≠a de mapas no disponible', 'error');
                return;
            }

            console.log('‚úÖ Leaflet disponible');

            // Inicializar mapa
            const mapaOk = initMap();
            if (!mapaOk) {
                console.error('‚ùå Fallo al inicializar mapa');
                return;
            }

            // Cargar usuarios inmediatamente
            cargarUsuarios();

            // Limpiar campos de fecha
            const fi = document.getElementById('filterFechaInicio');
            const ff = document.getElementById('filterFechaFin');
            if (fi) fi.value = '';
            if (ff) ff.value = '';

            // Cargar ubicaciones iniciales despu√©s de un breve delay
            setTimeout(() => {
                console.log('üöÄ Cargando ubicaciones iniciales...');
                cargarUbicaciones(true);
            }, 1000);
        });
    </script>
</body>

</html>
